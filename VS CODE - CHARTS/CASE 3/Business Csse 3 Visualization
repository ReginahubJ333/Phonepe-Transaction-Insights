import mysql.connector
import pandas as pd
import matplotlib.pyplot as plt
import plotly.express as px

# TOTAL TRANSACTION VOLUME BY STATE

conn = mysql.connector.connect(
    host="localhost",
    user="root",
    password="Admin",
    database="phonepe")

query1 = """
SELECT State, SUM(Count) AS Transaction_Count
FROM map_transaction
GROUP BY State
ORDER BY Transaction_Count DESC
LIMIT 5;
"""

df = pd.read_sql(query1, conn)
conn.close()

plt.figure(figsize=(9,5))
bars = plt.barh(df["State"], df["Transaction_Count"], color="teal")
plt.xlabel("Transaction Count")
plt.ylabel("State")
plt.title("Top 5 States by Transaction Count")
plt.gca().invert_yaxis()
plt.grid(axis='x', linestyle="--", alpha=0.6)
plt.tight_layout()
plt.show()

# TOP 10 DISTRICTS BY TRANSACTION VOLUME

conn = mysql.connector.connect(
    host="localhost",
    user="root",
    password="Admin",
    database="phonepe"
)

query2 = """   
    SELECT State, District, SUM(Count) AS Total_Transaction
FROM map_transaction
GROUP BY State, District
ORDER BY Total_Transaction DESC
LIMIT 10;
"""
df = pd.read_sql(query2,conn)
conn.close()

plt.figure(figsize=(12,6))
plt.barh(df['District'] + " ("+df['State'] + ")", df['Total_Transaction']/1e9)
plt.xlabel('Transaction Count (in Billions)')
plt.ylabel('District (State)')
plt.title('Top 10 Districts by Phonepe Transaction Volume')
plt.gca().invert_yaxis()
plt.tight_layout()
plt.show()

# TOP PIN CODES BY TRANSACTION VOLUME

conn = mysql.connector.connect(
    host="localhost",
    user="root",
    password="Admin",
    database="phonepe")

query3 = """
SELECT State, Entity_Name AS Pincodes, SUM(Amount) AS Total_Transactions
FROM top_transaction
WHERE Level = 'Pincodes'
GROUP BY State, Entity_Name
ORDER BY Total_Transactions DESC
LIMIT 10;
"""

df = pd.read_sql(query3, conn)
conn.close()

df["Total_Transactions_Cr"] = df["Total_Transactions"]/10**7
df = df.sort_values("Total_Transactions_Cr", ascending=True)

fig = px.bar(
    df,
    x="Total_Transactions_Cr",
    y="Pincodes",
    color="State",
    orientation="h",
    text_auto=".2s",
    title="Top 10 Pincodes by Transaction Volume (Crores)")

fig.update_layout(
    xaxis_title="Pincode",
    yaxis_title="Total Transaction Value (crores)",
    template="plotly_white",
    showlegend=True)
fig.show()

# YEAR ON YEAR GROWTH IN TRANSACTIONS BY STATES

conn = mysql.connector.connect(
    host="localhost",
    user="root",
    password="Admin",
    database="phonepe")

query4 = """
SELECT State, Year, SUM(Count) AS Current_Year_Transaction,
		 LAG(SUM(Count)) OVER (PARTITION BY State ORDER BY Year) AS Previous_Year_Transaction,
		 ROUND(((SUM(Count) - LAG(SUM(Count)) OVER (PARTITION BY State ORDER BY Year))
			  / LAG(SUM(Count)) OVER (PARTITION BY State ORDER BY Year)) * 100, 2) AS Growth_Percentage
	FROM map_transaction
	GROUP BY State, Year
	ORDER BY State, Year;
 """

df = pd.read_sql(query4, conn)
conn.close()

df = df.dropna(subset=["Growth_Percentage"])
top_states = df.groupby("State")["Current_Year_Transaction"].sum().nlargest(5).index
df_top = df[df["State"].isin(top_states)]

fig = px.line(
    df_top,
    x="Year",
    y="Growth_Percentage",
    color="State",
    markers=True,
    title=" Year on Year Growth in Transactions By Top States",
)
fig.update_layout(
    yaxis_title="Growth_Percentage (%)",
    xaxis_title="Year",
    template="plotly_white",
    legend_title="State",)
fig.show()

# TOTAL TRANSACTION VALUE BY STATE AND TRANSACTION TYPE

conn = mysql.connector.connect(
    host="localhost",
    user="root",
    password="Admin",
    database="phonepe")

query5 = """
SELECT State, Category, SUM(Amount) AS Total_Transaction_Value
FROM aggregated_transaction
GROUP BY State, Category
ORDER BY Total_Transaction_Value DESC;
"""

df = pd.read_sql(query5, conn)
conn.close()

df["Total_Transaction_Value_Cr"] = df["Total_Transaction_Value"]/1e7
top_states = df.groupby("State")["Total_Transaction_Value_Cr"].sum().nlargest(10).index
df_top = df[df["State"].isin(top_states)]

fig = px.bar(
    df_top,
    x="State",
    y="Total_Transaction_Value_Cr",
    color="Category",
    barmode="group",
    title="Total Transaction value by State and Category")

fig.update_layout(
    xaxis_title="State",
    yaxis_title="Total Transaction Value (in crores)",
    template="plotly_white",
    legend_title="Category")
fig.show()